<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Document</title>
  <link rel="stylesheet" href="./styles.css">
</head>
<body>
  <div>
    <h1>NostrEmitter Demo</h1>
    <div class="container">
      <div class="chat-status">
      </div>
    </div>
    <div class="container">
      <form id="config">
        <div class="form-field">
          <label>Relay Address</label>
          <input name="address" value="" placeholder="enter relay url ...">
        </div>
        <div class="form-field">
          <label>Channel Topic</label>
          <input name="topic" value="" placeholder="enter topic ...">
        </div>
        <button type="submit">Connect</button>
      </form>
    </div>
    <div class="container">
      <h2>Messages</h2>
      <div class="chat-box">
      </div>
    </div>
    <div class="container">
      <form class="send-box">
        <input name="message" value="" placeholder="type here ...">
        <button id="send-button" type="submit">Send</button>
      </form> 
    </div>
  </div>
  <script src="https://unpkg.com/@cmdcode/nostr-emitter@2.0.0"></script>
  <script type="module">
    const DEFAULT_RELAY_URL = 'wss://relay-pub.deschooling.us'
    const { NostrClient, KeyPair } = window.nostrEmitter
    const { prvkey, pubkey }       = KeyPair.random()

    const configForm = document.querySelector('#config'),
          statusBox  = document.querySelector('.chat-status'),
          msgBox     = document.querySelector('.chat-box'),
          sendBox    = document.querySelector('.send-box'),
          relayAddr  = document.querySelector('input[name="address"]')

    if (!relayAddr.getAttribute('value')) relayAddr.setAttribute('value', DEFAULT_RELAY_URL)

    configForm.addEventListener('submit', async (e) => {
      e.preventDefault()

      let { address, topic } = Object.fromEntries(new FormData(e.target))

      console.log(address, topic)
      
      if (!topic) topic = 'general'

      const client  = new NostrClient(prvkey, { selfsub : true })

      client.on('ready', (emitter) => {
        // statusBox.innerText = `Connected`

        console.log('Connected to', emitter.client.address)

        emitter.on('join', (_, event) => {
          if (!event.isAuthor) join(event.pubkey)
        })

        emitter.on('chatmsg', (content, event) => {
          const name = (event.isAuthor) ? 'me' : event.pubkey.slice(-6)
          post(name, content)
        })
        emitter.relay('join')
      })

      const emitter = await client.connect(address, topic)

      sendBox.addEventListener('submit', (e) => {
        e.preventDefault()
        const { message } = Object.fromEntries(new FormData(e.target))
        emitter.relay('chatmsg', message)
        clearInput()
      })
    })

    function join(name) {
      const message = document.createElement('pre')
      message.innerText = `${name.slice(-6)} has entered the chat.`
      msgBox.appendChild(message)
    }

    function post(name, msg) {
      const message = document.createElement('pre')
      message.innerText = `<${name}> ${msg}`
      msgBox.appendChild(message)
    }

    function clearInput() {
      const sendInput = document.querySelector('.send-box input')
      sendInput.value = ''
    }
  </script>
</body>
</html>